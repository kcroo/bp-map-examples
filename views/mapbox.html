<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="public/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
    <title>Document</title>
</head>
<body>

    <div id="mapid"></div>
    <div id="description" class="inactive description"></div>

    <script>
        // returns promise for loading GeoJSON file and adding the Leaflet layer to the layers array
        async function getGeojsonLayer(fileName, layers) {
            // loading GeoJSON file - Here my html and usa_adm.geojson file resides in same folder
            return $.getJSON(fileName, (data) => {
                layers.push(data);
            })
        }

        const map = new mapboxgl.Map({
           container: 'mapid',
           style: 'https://tiles.stadiamaps.com/styles/alidade_smooth.json',  // Theme URL; see our themes documentation for more options
         });

         // Add zoom and rotation controls to the map.
         map.addControl(new mapboxgl.NavigationControl());

        const layers = [];
        const promises = [];

        // get promises for each of the CA state senate districts
        for (let i = 1; i <= 40; i++) {
            const promise = getGeojsonLayer(`/ca_state_senate_districts/bp_california state senate district ${i}.geojson`, layers);
            promises.push(promise);
        }
        
        // create your own GeoJSON feature collection
        var featureCollection = {
            'type': 'FeatureCollection',
            'features': []
        };

        // after all GeoJSON files load, add them to group layer, add to map, and zoom to bounds
        Promise.all(promises).then( () => {
            // create feature for GeoJSON feature collection
            for (let i = 1; i <= 40; i++) {
                const feature = {
                    'type': 'Feature',
                    'geometry': layers[i-1],
                    'properties': {
                        'name': `District ${i}`
                    }
                };

                featureCollection.features.push(feature);
            }

            console.log(featureCollection);

            // zoom to bounds (requires turf or geojson-extent plugin)
            const bbox = turf.extent(featureCollection);

            map.fitBounds(bbox, {
                padding: 20
            });

            // add feature collection as dat source to map
            map.addSource('featureCollectionID', {
                type: 'geojson',
                data: featureCollection
            });

            // creates layers for each feature in feature collection
            map.addLayer({
                'id': 'layerID',
                'type': 'fill',     // MUST be fill, otherwise click event doesn't work
                'source': 'featureCollectionID',
                'layout': {},
                'paint': {
                    'fill-color': '#0000FF',
                    'fill-opacity': 0.2,                // can't make fill opaque --> outline doesn't show
                    'fill-outline-color': '#0000FF'
                }
            });

            // // *** popup displays on click ***
            // // https://docs.mapbox.com/mapbox-gl-js/example/polygon-popup-on-click/
            // map.on('click', 'layerID', function(e) {
            //     console.log(e);
 
            //     var coordinates = e.lngLat;
            //     var name = e.features[0].properties.name;
                
            //     // popup will appear where user clicked, with district name
            //     const popup = new mapboxgl.Popup()
            //         .setLngLat(coordinates)     // could set to middle of polygon
            //         .setHTML(name)
            //         .addTo(map);
            // });

            // // Change the cursor to a pointer when the mouse is over the places layer.
            // map.on('mouseenter', 'layerID', function() {
            //     map.getCanvas().style.cursor = 'pointer';
            // });
            
            // // Change it back to a pointer when it leaves.
            // map.on('mouseleave', 'layerID', function() {
            //     map.getCanvas().style.cursor = '';
            // });


            // *** popup displays on hover ***
            // if wanted to change to mouseon, would need to manually position popup over middle of polygon

            // only one popup visible on map at one time
            const popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false
            });

            map.on('mouseenter', 'layerID', function(e) {
                console.log(e);
                map.getCanvas().style.cursor = 'pointer';
 
                var coordinates = e.lngLat;
                var name = e.features[0].properties.name;

                // supposed to help point at specific feature being hovered over
                // just copy and pasted from https://docs.mapbox.com/mapbox-gl-js/example/popup-on-hover/
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }
                
                // popup will appear where mouse entered polygon, with district name
                popup
                    .setLngLat(coordinates)     // could set to middle of polygon
                    .setHTML(name)
                    .addTo(map);
            });
            
            // Change it back to a pointer when it leaves.
            map.on('mouseleave', 'layerID', function() {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });
            
        });

    </script>
</body>
</html>

